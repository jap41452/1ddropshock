<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SDOF Drop Shock V2.1</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --w: 920px;
    --border:#9aa4b2;
    --panel:#d9d9d9;
    --panel2:#efefef;
    --ink:#0b1220;
    --muted:#1f2937;
    --red:#c00000;
    --grid:#8a8f98;
  }
  body{
    margin:0;
    background:#fff;
    font-family: Arial, Helvetica, sans-serif;
    color:var(--ink);
  }
  .wrap{
    width: min(var(--w), calc(100vw - 16px));
    margin: 10px auto 18px;
    border:1px solid var(--border);
    background: var(--panel);
  }
  .topbar{
    display:grid;
    grid-template-columns: 1fr 1fr;
    align-items:center;
    padding:6px 10px;
    background:#cfcfcf;
    border-bottom:1px solid var(--border);
    font-weight:700;
    font-size:14px;
  }
  .topbar .r{ text-align:center; }

  .upper{
    display:grid;
    grid-template-columns: 260px 250px 1fr;
    gap:10px;
    padding:10px;
  }

  /* Compact “table” blocks */
  .blk{
    background: var(--panel);
  }
  .rows{
    display:grid;
    grid-template-columns: 40px 1fr;
    row-gap:8px;
    column-gap:10px;
    align-items:center;
    font-size:13px;
  }
  .lab{
    display:flex;
    align-items:center;
    gap:6px;
    justify-content:flex-start;
  }
  .tri{
    width:0;height:0;
    border-left:7px solid transparent;
    border-right:0 solid transparent;
    border-top:7px solid var(--red);
    transform: rotate(45deg);
    margin-left:2px;
  }
  .inpline{
    display:grid;
    grid-template-columns: 1fr;
  }
  input{
    width:100%;
    height:22px;
    padding:2px 6px;
    font-size:13px;
    border:1px solid #333;
    background:#fff;
    box-sizing:border-box;
  }
  input[readonly]{
    background:#f7f7f7;
  }
  .unitHint{
    font-size:11px;
    color:#222;
    opacity:.8;
    margin-top:2px;
  }

  .summaryRows{
    display:grid;
    grid-template-columns: 1fr 1fr;
    row-gap:8px;
    column-gap:10px;
    align-items:center;
    font-size:13px;
  }
  .sumLab{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .sumVal{
    text-align:left;
    font-weight:700;
  }

  /* Schematic panel */
  .schem{
    background: var(--panel);
    border-left:0;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }
  canvas#schem{
    width: 220px;
    height: 150px;
    border:0;
    background: var(--panel);
  }

  /* Controls row (small, like an embedded tool) */
  .controls{
    padding: 0 10px 8px;
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }
  .btn{
    height:24px;
    padding:0 10px;
    border:1px solid #333;
    background:#f2f2f2;
    font-weight:700;
    font-size:12px;
    cursor:pointer;
  }
  .btn:disabled{ opacity:.55; cursor:not-allowed; }
  .ctl{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:12px;
  }
  input[type="range"]{ height:auto; }

  /* Plot block */
  .plotWrap{
    background:#fff;
    border-top:1px solid var(--border);
    padding:8px 10px 10px;
  }
  .plotBox{
    background:#fff;
    border:1px solid #333;
    padding:6px;
  }
  #chart{
    width:100%;
    height:290px;
  }

  @media (max-width: 860px){
    .upper{ grid-template-columns: 1fr; }
    canvas#schem{ width: 260px; height: 170px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div>SDOF Drop Shock V2.1</div>
    <div class="r">XL4SIM</div>
  </div>

  <div class="upper">
    <!-- Inputs -->
    <div class="blk">
      <div class="rows" style="padding:4px 2px 0;">
        <div class="lab"><div style="width:18px;text-align:right;font-weight:700;">W</div><div class="tri"></div></div>
        <div class="inpline"><input id="W" type="number" step="any" value="100"></div>

        <div class="lab"><div style="width:18px;text-align:right;font-weight:700;">k</div><div class="tri"></div></div>
        <div class="inpline"><input id="k" type="number" step="any" value="1000"></div>

        <div class="lab"><div style="width:18px;text-align:right;font-weight:700;">c</div><div class="tri"></div></div>
        <div class="inpline"><input id="c" type="number" step="any" value="4"></div>

        <div class="lab"><div style="width:18px;text-align:right;font-weight:700;">G</div><div class="tri"></div></div>
        <div class="inpline"><input id="g" type="number" step="any" value="386.4"></div>

        <div class="lab"><div style="width:18px;text-align:right;font-weight:700;">h</div><div class="tri"></div></div>
        <div class="inpline"><input id="h" type="number" step="any" value="1"></div>

        <div class="lab"><div style="width:18px;text-align:right;font-weight:700;">V<sub>0</sub></div><div class="tri"></div></div>
        <div class="inpline"><input id="v0" type="number" step="any" value="10"></div>
      </div>

      <div class="unitHint" style="padding:6px 2px 0;">
        US-style consistent units (e.g., W=lbf, k=lbf/in, c=lbf·s/in, G=in/s², h=in, V0=in/s)
      </div>
    </div>

    <!-- Summary -->
    <div class="blk">
      <div class="summaryRows" style="padding:4px 2px 0;">
        <div class="sumLab"><div style="width:64px;font-weight:700;">f<sub>n</sub></div><div class="tri"></div></div>
        <div class="sumVal" id="fn">—</div>

        <div class="sumLab"><div style="width:64px;font-weight:700;">c<sub>c</sub></div><div class="tri"></div></div>
        <div class="sumVal" id="cc">—</div>

        <div class="sumLab"><div style="width:64px;font-weight:700;">&#950;</div><div class="tri"></div></div>
        <div class="sumVal" id="zeta">—</div>

        <div class="sumLab"><div style="width:110px;font-weight:700;">initial contact t</div><div class="tri"></div></div>
        <div class="sumVal" id="tC">—</div>

        <div class="sumLab"><div style="width:64px;font-weight:700;">g max</div><div class="tri"></div></div>
        <div class="sumVal" id="gmax">—</div>

        <div class="sumLab"><div style="width:64px;font-weight:700;">&#916; max</div><div class="tri"></div></div>
        <div class="sumVal" id="dmax">—</div>
      </div>

      <div class="unitHint" style="padding:8px 2px 0;">
        Auto-stop: 20 cycles from initial contact.
      </div>
    </div>

    <!-- Schematic -->
    <div class="schem">
      <canvas id="schem" width="440" height="300"></canvas>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="run">Run</button>
    <button class="btn" id="pause" disabled>Pause</button>
    <button class="btn" id="stop" disabled>Stop</button>

    <div class="ctl" style="margin-left:auto;">
      <div style="font-weight:700;">Animation speed</div>
      <input id="speed" type="range" min="0.1" max="4" step="0.1" value="1.0">
      <div id="speedLbl" style="width:48px;text-align:right;font-weight:700;">1.0×</div>
    </div>
  </div>

  <div class="plotWrap">
    <div class="plotBox">
      <canvas id="chart"></canvas>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const fmt = (x, n=3) => {
    if (!isFinite(x)) return "—";
    const ax = Math.abs(x);
    if (ax >= 1000) return x.toFixed(0);
    if (ax >= 100)  return x.toFixed(1);
    if (ax >= 10)   return x.toFixed(2);
    return x.toFixed(n);
  };

  const inp = {
    W: $("W"), k: $("k"), c: $("c"), g: $("g"), h: $("h"), v0: $("v0")
  };
  const out = {
    fn: $("fn"), cc: $("cc"), zeta: $("zeta"), tC: $("tC"), gmax: $("gmax"), dmax: $("dmax")
  };
  const btnRun = $("run"), btnPause = $("pause"), btnStop = $("stop");
  const speed = $("speed"), speedLbl = $("speedLbl");

  // Chart
  const chart = new Chart($("chart").getContext("2d"), {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { label: "Displacement, y", data: [], borderWidth: 2, pointRadius: 0, tension: 0.05, yAxisID: "yDisp" },
        { label: "Acceleration", data: [], borderWidth: 2, pointRadius: 0, tension: 0.05, borderDash: [6,4], yAxisID: "yG" }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { position: "top" } },
      scales: {
        x: { title: { display: true, text: "Time, sec." }, ticks: { maxTicksLimit: 10 } },
        yDisp: { position: "left", title: { display: true, text: "Displacement" } },
        yG: { position: "right", title: { display: true, text: "Accelerometer Reading, g's" }, grid: { drawOnChartArea:false } }
      }
    }
  });

  // Schematic drawing (compact, like your figure)
  const canv = $("schem");
  const ctx = canv.getContext("2d");

  function drawSchematic(tNow, yNow, params){
    // scale to canvas resolution
    const w = canv.width, h = canv.height;
    ctx.clearRect(0,0,w,h);

    // background
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--panel").trim() || "#d9d9d9";
    ctx.fillRect(0,0,w,h);

    // coordinate system
    const baseY = Math.round(h*0.80);
    const xMid = Math.round(w*0.70);
    const yContact = Math.round(h*0.38);

    // ground line
    ctx.strokeStyle = "#111827";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(Math.round(w*0.12), baseY);
    ctx.lineTo(Math.round(w*0.92), baseY);
    ctx.stroke();

    // reference line at contact
    ctx.strokeStyle = "#111827";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(Math.round(w*0.52), yContact);
    ctx.lineTo(Math.round(w*0.92), yContact);
    ctx.stroke();

    // height bracket "h"
    const xH = Math.round(w*0.48);
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = "#111827";
    ctx.beginPath();
    ctx.moveTo(xH, Math.round(h*0.20));
    ctx.lineTo(xH, yContact);
    ctx.stroke();
    // end ticks
    ctx.beginPath();
    ctx.moveTo(xH-12, Math.round(h*0.20));
    ctx.lineTo(xH+12, Math.round(h*0.20));
    ctx.moveTo(xH-12, yContact);
    ctx.lineTo(xH+12, yContact);
    ctx.stroke();
    ctx.fillStyle = "#111827";
    ctx.font = "18px Arial";
    ctx.fillText("h", xH-34, Math.round((h*0.20 + yContact)/2));

    // arrows for W and v0 (schematic)
    function arrow(x1,y1,x2,y2){
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      const ang = Math.atan2(y2-y1, x2-x1), L=12;
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2 - L*Math.cos(ang - Math.PI/7), y2 - L*Math.sin(ang - Math.PI/7));
      ctx.lineTo(x2 - L*Math.cos(ang + Math.PI/7), y2 - L*Math.sin(ang + Math.PI/7));
      ctx.closePath();
      ctx.fillStyle = ctx.strokeStyle;
      ctx.fill();
    }

    // map yNow (physical, down) to pixels from contact
    const yMaxVis = Math.max(1e-9, (params && params.yMax) ? params.yMax : 1);
    const dispScale = Math.round((baseY - yContact) * 0.55);
    const yPix = yContact + clamp(yNow / yMaxVis, -1.0, 1.2) * dispScale;

    // draw spring and damper below mass to base
    const top = yContact;
    const bottom = baseY;

    drawDamper(xMid-60, top, xMid-60, bottom);
    drawSpring(xMid+10, top, xMid+10, bottom);

    // mass block
    const bw = 120, bh = 70;
    const xB = xMid - bw/2;
    const yB = Math.round(yPix - bh/2);

    ctx.fillStyle = "#cfd5dd";
    ctx.strokeStyle = "#111827";
    ctx.lineWidth = 3;
    roundRect(xB, yB, bw, bh, 16);

    // "W" inside
    ctx.fillStyle = "#111827";
    ctx.font = "22px Arial";
    ctx.fillText("W", xB + bw/2 - 10, yB + bh/2 + 8);

    // W arrow downward
    ctx.strokeStyle = "#111827";
    ctx.lineWidth = 2;
    arrow(xB + bw/2, yB + 10, xB + bw/2, yB + bh - 6);

    // v0 arrow near left
    ctx.lineWidth = 2;
    arrow(Math.round(w*0.58), Math.round(h*0.48), Math.round(w*0.58), Math.round(h*0.62));
    ctx.font = "18px Arial";
    ctx.fillText("V\u2080", Math.round(w*0.60), Math.round(h*0.56));

    // labels c and k
    ctx.font = "18px Arial";
    ctx.fillText("c", xMid-80, Math.round((top+bottom)/2));
    ctx.fillText("k", xMid+30, Math.round((top+bottom)/2));

    // y axis label
    ctx.font = "18px Arial";
    ctx.fillText("y", xMid+78, bottom-18);

    // time at top-left
    ctx.font = "18px Arial";
    ctx.fillStyle = "#111827";
    ctx.fillText("t = " + fmt(tNow,3) + " s", Math.round(w*0.10), Math.round(h*0.12));

    // g_out(t) label at upper right
    ctx.font = "16px Arial";
    ctx.fillText("g\u2092\u2094\u209C(t)", Math.round(w*0.78), Math.round(h*0.22));
  }

  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  }

  function drawSpring(x1,y1,x2,y2){
    ctx.strokeStyle = "#111827";
    ctx.lineWidth = 2;
    const turns = 8, amp = 14;
    const dy = y2 - y1;
    const seg = dy / (turns*2);
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    let x = x1, y = y1;
    for (let i=0; i<turns*2; i++){
      y += seg;
      x = x1 + (i%2===0 ? -amp : amp);
      ctx.lineTo(x, y);
    }
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  function drawDamper(x,y1,x2,y2){
    ctx.strokeStyle = "#111827";
    ctx.lineWidth = 2;
    const mid = (y1+y2)/2;

    // top rod
    ctx.beginPath();
    ctx.moveTo(x, y1);
    ctx.lineTo(x, mid-30);
    ctx.stroke();

    // piston box
    ctx.beginPath();
    ctx.rect(x-18, mid-30, 36, 24);
    ctx.stroke();

    // bottom rod
    ctx.beginPath();
    ctx.moveTo(x, mid-6);
    ctx.lineTo(x, y2);
    ctx.stroke();
  }

  // Physics
  function computeContactTime(h, v0, g){
    // 0 = -h + v0 t + 0.5 g t^2
    const a = 0.5*g, b = v0, c = -h;
    const disc = b*b - 4*a*c;
    if (disc < 0) return NaN;
    const t1 = (-b + Math.sqrt(disc)) / (2*a);
    const t2 = (-b - Math.sqrt(disc)) / (2*a);
    const cand = [t1,t2].filter(t => t >= 0).sort((p,q)=>p-q);
    return cand.length ? cand[0] : NaN;
  }

  function simulate(){
    const W = +inp.W.value;
    const k = +inp.k.value;
    const c = +inp.c.value;
    const g = +inp.g.value;
    const h = +inp.h.value;
    const v0 = +inp.v0.value;

    if (!(W>0) || !(k>0) || !(g>0) || !(h>=0)){
      alert("Enter valid positive W, k, G and nonnegative h.");
      return null;
    }

    const m = W/g;
    const wn = Math.sqrt(k/m);
    const fn = wn/(2*Math.PI);
    const cc = 2*m*wn;
    const zeta = c/cc;

    const tC = (h===0) ? 0 : computeContactTime(h, v0, g);

    // Stop time: 20 cycles from contact
    const cycles = 20;
    const tStop = tC + cycles / Math.max(1e-9, fn);

    // If you want 20 cycles from t=0 instead, use:
    // const tStop = cycles / Math.max(1e-9, fn);

    // dt: stable + smooth; compact module prefers speed over excessive resolution
    const dt = Math.min(0.0005, 1/(fn*500 + 250));
    const dtUse = Math.max(1e-5, dt);

    const t = [], y = [], v = [], a = [], gRead = [];
    // Free fall
    const nFF = Math.max(0, Math.ceil(tC/dtUse));
    for (let i=0; i<=nFF; i++){
      const tt = i*dtUse;
      const yy = -h + v0*tt + 0.5*g*tt*tt;
      const vv = v0 + g*tt;
      const aa = g;
      t.push(tt); y.push(yy); v.push(vv); a.push(aa);
      gRead.push(Math.abs(aa)/g);
    }

    // Post-contact RK4
    function deriv(yy,vv){
      const acc = g - (c/m)*vv - (k/m)*yy;
      return {dy: vv, dv: acc};
    }

    let tt = isFinite(tC) ? tC : 0;
    let yy = 0;
    let vv = isFinite(tC) ? (v0 + g*tC) : v0;

    while (tt < tStop - 0.5*dtUse){
      // RK4
      const k1 = deriv(yy, vv);
      const k2 = deriv(yy + 0.5*dtUse*k1.dy, vv + 0.5*dtUse*k1.dv);
      const k3 = deriv(yy + 0.5*dtUse*k2.dy, vv + 0.5*dtUse*k2.dv);
      const k4 = deriv(yy + dtUse*k3.dy, vv + dtUse*k3.dv);

      yy = yy + (dtUse/6)*(k1.dy + 2*k2.dy + 2*k3.dy + k4.dy);
      vv = vv + (dtUse/6)*(k1.dv + 2*k2.dv + 2*k3.dv + k4.dv);
      tt = tt + dtUse;

      const acc = g - (c/m)*vv - (k/m)*yy;

      t.push(tt); y.push(yy); v.push(vv); a.push(acc);
      gRead.push(Math.abs(acc)/g);
    }

    const yMax = Math.max(...y);
    const gMax = Math.max(...gRead);

    return { W,k,c,g,h,v0, m, wn, fn, cc, zeta, tC, tStop, t, y, gRead, yMax, gMax };
  }

  function writeSummary(sim){
    out.fn.innerHTML = fmt(sim.fn,3) + " Hz";
    out.cc.textContent = fmt(sim.cc,3);
    out.zeta.innerHTML = fmt(sim.zeta*100,1) + " %";
    out.tC.textContent = fmt(sim.tC,4) + " s";
    out.gmax.innerHTML = fmt(sim.gMax,2) + " g";
    out.dmax.textContent = fmt(sim.yMax,4);
  }

  function setButtons(running, paused){
    btnRun.disabled = running && !paused;
    btnPause.disabled = !running;
    btnStop.disabled = !running;
    btnPause.textContent = paused ? "Resume" : "Pause";
  }

  // Animation
  let sim = null;
  let anim = { running:false, paused:false, idx:0, t0:0 };
  let raf = null;

  function updateChartTo(idx){
    chart.data.labels = sim.t.slice(0, idx+1).map(x => x.toFixed(4));
    chart.data.datasets[0].data = sim.y.slice(0, idx+1);
    chart.data.datasets[1].data = sim.gRead.slice(0, idx+1);
    chart.update();
  }

  function start(){
    sim = simulate();
    if (!sim) return;

    writeSummary(sim);

    chart.data.labels = [];
    chart.data.datasets[0].data = [];
    chart.data.datasets[1].data = [];
    chart.update();

    anim.running = true;
    anim.paused = false;
    anim.idx = 0;
    anim.t0 = performance.now();
    setButtons(true,false);

    const step = () => {
      if (!anim.running) return;

      const spd = +speed.value;
      const now = performance.now();

      if (!anim.paused){
        const dtSec = ((now - anim.t0)/1000) * spd;
        anim.t0 = now;

        const tTarget = sim.t[anim.idx] + dtSec;
        while (anim.idx < sim.t.length-1 && sim.t[anim.idx] < tTarget){
          anim.idx++;
        }

        // stop automatically at end (already truncated to 20 cycles)
        if (anim.idx >= sim.t.length-1){
          anim.idx = sim.t.length-1;
          updateChartTo(anim.idx);
          drawSchematic(sim.t[anim.idx], sim.y[anim.idx], sim);
          stop(true);
          return;
        }
      } else {
        anim.t0 = now;
      }

      updateChartTo(anim.idx);
      drawSchematic(sim.t[anim.idx], sim.y[anim.idx], sim);

      raf = requestAnimationFrame(step);
    };

    cancelAnimationFrame(raf);
    raf = requestAnimationFrame(step);
  }

  function stop(auto=false){
    anim.running = false;
    anim.paused = false;
    setButtons(false,false);
    cancelAnimationFrame(raf);
    raf = null;

    // leave final plot/schematic up
    if (sim){
      updateChartTo(sim.t.length-1);
      drawSchematic(sim.t[sim.t.length-1], sim.y[sim.y.length-1], sim);
    }
  }

  btnRun.addEventListener("click", start);

  btnPause.addEventListener("click", () => {
    if (!anim.running) return;
    anim.paused = !anim.paused;
    setButtons(true, anim.paused);
  });

  btnStop.addEventListener("click", () => stop(false));

  speed.addEventListener("input", () => speedLbl.textContent = (+speed.value).toFixed(1) + "×");

  // Initial schematic
  speedLbl.textContent = (+speed.value).toFixed(1) + "×";
  drawSchematic(0, -Math.max(0, +inp.h.value || 0), {yMax: Math.max(1e-6, +inp.h.value || 1)});
})();
</script>
</body>
</html>

